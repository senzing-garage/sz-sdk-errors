#! /usr/bin/env python3

"""
Used to generate go/main.go
"""

import json
import logging
import os
from datetime import datetime, timezone

INPUT_FILE = "szerrors.json"
OUTPUT_FILE = "go/main.go"


def spaces_not_tabs():
    """Because tabs are used in OUTPUT_HEADER, linters get confused with spaces vs. tabs.  This solves it."""


# -----------------------------------------------------------------------------
# --- Main
# -----------------------------------------------------------------------------

# Set up logging.

logging.basicConfig(format="%(asctime)s %(message)s", level=logging.INFO)

logging.info("-" * 80)
logging.info("--- %s - Begin", os.path.basename(__file__))
logging.info("-" * 80)

# Create multi-line strings for output.

OUTPUT_HEADER = """// DO NOT EDIT.  This code is generated.
// Generated by: sz-sdk-errors/bin/generate_go.py
// Generated for: sz-sdk-go/szerror/main.go
"""

OUTPUT_HEADER += f"// Generated date: {datetime.now(timezone.utc).isoformat()}\n"

# noqa: E101
OUTPUT_HEADER += """
package szerror

// ----------------------------------------------------------------------------
// Types
// ----------------------------------------------------------------------------

type SzErrorTypeIds int

// ----------------------------------------------------------------------------
// "Category" errors
// One of these errors must be the last in each SZErrorTypes value list.
// ----------------------------------------------------------------------------

type SzBadInputError struct {
	error
	SzErrorTypeIds []SzErrorTypeIds
}
type SZBaseError struct {
	error
	SzErrorTypeIds []SzErrorTypeIds
}
type SzConfigurationError struct {
	error
	SzErrorTypeIds []SzErrorTypeIds
}
type SzRetryableError struct {
	error
	SzErrorTypeIds []SzErrorTypeIds
}
type SzUnrecoverableError struct {
	error
	SzErrorTypeIds []SzErrorTypeIds
}

// ----------------------------------------------------------------------------
// Detail errors
// ----------------------------------------------------------------------------

type SzDatabaseConnectionLostError struct{ error }
type SzDatabaseError struct{ error }
type SzLicenseError struct{ error }
type SzNotFoundError struct{ error }
type SzNotInitializedError struct{ error }
type SzRetryTimeoutExceededError struct{ error }
type SzUnhandledError struct{ error }
type SzUnknownDatasourceError struct{ error }

// ----------------------------------------------------------------------------
// Constants
// ----------------------------------------------------------------------------

const (
	SzBase SzErrorTypeIds = iota
	SzBadInput
	SzConfiguration
	SzDatabase
	SzDatabaseConnectionLost
	SzLicense
	SzNotFound
	SzNotInitialized
	SzRetryable
	SzRetryTimeoutExceeded
	SzUnhandled
	SzUnknownDatasource
	SzUnrecoverable
)

// ----------------------------------------------------------------------------
// Variables
// ----------------------------------------------------------------------------

// Message templates for szengine implementations.
// Note: The lists of SzErrorTypeIds are from innermost error to outer most error.
// Example:  #10 is SzRetryableError{SzRetryTimeoutExceededError{errors.New(message)}}
var SzErrorTypes = map[int][]SzErrorTypeIds{
"""  # noqa: E101, W191

OUTPUT_FOOTER = """
}

// A list of all SzErrorTypeIds.
var AllSzErrorTypes = []SzErrorTypeIds{
	SzBadInput,
	SzBase,
	SzConfiguration,
	SzDatabase,
	SzDatabaseConnectionLost,
	SzLicense,
	SzNotFound,
	SzNotInitialized,
	SzRetryable,
	SzRetryTimeoutExceeded,
	SzUnhandled,
	SzUnknownDatasource,
	SzUnrecoverable,
}
"""  # noqa: E101,F541,W191


with open(INPUT_FILE, encoding="utf-8") as input_file:
    errors = json.load(input_file)

with open(OUTPUT_FILE, "w", encoding="utf-8") as file:
    file.write(OUTPUT_HEADER)
    for error_number, error_data in errors.items():
        OUTPUT_LINE = ""
        error_class = error_data.get("class")
        if error_class:
            CLASS_VARIABLE = error_class.removesuffix("Error")
            match CLASS_VARIABLE:
                case "Sz":
                    CLASS_VARIABLE = "SzBase"
                case "SzNotFound":
                    CLASS_VARIABLE = "SzNotFound, SzBadInput"
                case "SzUnknownDatasource":
                    CLASS_VARIABLE = "SzUnknownDatasource, SzBadInput"
                case "SzDatabaseConnectionLost":
                    CLASS_VARIABLE = "SzDatabaseConnectionLost, SzRetryable"
                case "SzRetryTimeoutExceeded":
                    CLASS_VARIABLE = "SzRetryTimeoutExceeded, SzRetryable"
                case "SzDatabase":
                    CLASS_VARIABLE = "SzDatabase, SzUnrecoverable"
                case "SzLicense":
                    CLASS_VARIABLE = "SzLicense, SzUnrecoverable"
                case "SzNotInitialized":
                    CLASS_VARIABLE = "SzNotInitialized, SzUnrecoverable"
                case "SzUnhandled":
                    CLASS_VARIABLE = "SzUnhandled, SzUnrecoverable"
            OUTPUT_LINE = f"{error_number}: {{{CLASS_VARIABLE}}},"
            error_name = error_data.get("name")
            error_comment = error_data.get("comment")
            if error_name or error_comment:
                OUTPUT_LINE += f" // {error_name} - {error_comment}"
        if len(OUTPUT_LINE) > 0:
            OUTPUT_LINE += "\n"
            file.write(OUTPUT_LINE)
    file.write(OUTPUT_FOOTER)

# Epilog.

logging.info("-" * 80)
logging.info("--- %s} - End", os.path.basename(__file__))
logging.info("-" * 80)
